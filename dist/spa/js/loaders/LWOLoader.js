(function(){let e;class t extends THREE.Loader{constructor(e,t={}){super(e),this.resourcePath=void 0!==t.resourcePath?t.resourcePath:""}load(e,t,a,s){const r=this,o=""===r.path?i(e,"Objects"):r.path,n=e.split(o).pop().split(".")[0],p=new THREE.FileLoader(this.manager);p.setPath(r.path),p.setResponseType("arraybuffer"),p.load(e,(function(a){try{t(r.parse(a,o,n))}catch(i){s?s(i):console.error(i),r.manager.itemError(e)}}),a,s)}parse(t,s,r){e=(new THREE.IFFParser).parse(t);const i=new THREE.TextureLoader(this.manager).setPath(this.resourcePath||s).setCrossOrigin(this.crossOrigin);return new a(i).parse(r)}}class a{constructor(e){this.textureLoader=e}parse(e){return this.materials=new s(this.textureLoader).parse(),this.defaultLayerName=e,this.meshes=this.parseLayers(),{materials:this.materials,meshes:this.meshes}}parseLayers(){const t=[],a=[],s=new r,i=this;return e.layers.forEach((function(e){const r=s.parse(e.geometry,e),o=i.parseMesh(r,e);t[e.number]=o,-1===e.parent?a.push(o):t[e.parent].add(o)})),this.applyPivots(a),a}parseMesh(e,t){let a;const s=this.getMaterials(e.userData.matNames,t.geometry.type);return this.duplicateUVs(e,s),a="points"===t.geometry.type?new THREE.Points(e,s):"lines"===t.geometry.type?new THREE.LineSegments(e,s):new THREE.Mesh(e,s),t.name?a.name=t.name:a.name=this.defaultLayerName+"_layer_"+t.number,a.userData.pivot=t.pivot,a}applyPivots(e){e.forEach((function(e){e.traverse((function(e){const t=e.userData.pivot;if(e.position.x+=t[0],e.position.y+=t[1],e.position.z+=t[2],e.parent){const t=e.parent.userData.pivot;e.position.x-=t[0],e.position.y-=t[1],e.position.z-=t[2]}}))}))}getMaterials(e,t){const a=[],s=this;e.forEach((function(e,t){a[t]=s.getMaterialByName(e)})),"points"!==t&&"lines"!==t||a.forEach((function(e,s){const r={color:e.color};"points"===t?(r.size=.1,r.map=e.map,a[s]=new THREE.PointsMaterial(r)):"lines"===t&&(a[s]=new THREE.LineBasicMaterial(r))}));const r=a.filter(Boolean);return 1===r.length?r[0]:a}getMaterialByName(e){return this.materials.filter((function(t){return t.name===e}))[0]}duplicateUVs(e,t){let a=!1;Array.isArray(t)?t.forEach((function(e){e.aoMap&&(a=!0)})):t.aoMap&&(a=!0),a&&e.setAttribute("uv2",new THREE.BufferAttribute(e.attributes.uv.array,2))}}class s{constructor(e){this.textureLoader=e}parse(){const t=[];this.textures={};for(const a in e.materials)"LWO3"===e.format?t.push(this.parseMaterial(e.materials[a],a,e.textures)):"LWO2"===e.format&&t.push(this.parseMaterialLwo2(e.materials[a],a,e.textures));return t}parseMaterial(e,t,a){let s={name:t,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)};const r=this.parseConnections(e.connections,e.nodes),i=this.parseTextureNodes(r.maps);this.parseAttributeImageMaps(r.attributes,a,i,e.maps);const o=this.parseAttributes(r.attributes,i);this.parseEnvMap(r,i,o),s=Object.assign(i,s),s=Object.assign(s,o);const n=this.getMaterialType(r.attributes);return new n(s)}parseMaterialLwo2(e,t){let a={name:t,side:this.getSide(e.attributes),flatShading:this.getSmooth(e.attributes)};const s=this.parseAttributes(e.attributes,{});return a=Object.assign(a,s),new THREE.MeshPhongMaterial(a)}getSide(e){if(!e.side)return THREE.BackSide;switch(e.side){case 0:case 1:return THREE.BackSide;case 2:return THREE.FrontSide;case 3:return THREE.DoubleSide}}getSmooth(e){return!e.smooth||!e.smooth}parseConnections(e,t){const a={maps:{}},s=e.inputName,r=e.inputNodeName,i=e.nodeName,o=this;return s.forEach((function(e,s){if("Material"===e){const e=o.getNodeByRefName(r[s],t);a.attributes=e.attributes,a.envMap=e.fileName,a.name=r[s]}})),i.forEach((function(e,i){e===a.name&&(a.maps[s[i]]=o.getNodeByRefName(r[i],t))})),a}getNodeByRefName(e,t){for(const a in t)if(t[a].refName===e)return t[a]}parseTextureNodes(e){const t={};for(const a in e){const s=e[a],r=s.fileName;if(!r)return;const i=this.loadTexture(r);switch(void 0!==s.widthWrappingMode&&(i.wrapS=this.getWrappingType(s.widthWrappingMode)),void 0!==s.heightWrappingMode&&(i.wrapT=this.getWrappingType(s.heightWrappingMode)),a){case"Color":t.map=i;break;case"Roughness":t.roughnessMap=i,t.roughness=1;break;case"Specular":t.specularMap=i,t.specular=16777215;break;case"Luminous":t.emissiveMap=i,t.emissive=8421504;break;case"Luminous THREE.Color":t.emissive=8421504;break;case"Metallic":t.metalnessMap=i,t.metalness=1;break;case"Transparency":case"Alpha":t.alphaMap=i,t.transparent=!0;break;case"Normal":t.normalMap=i,void 0!==s.amplitude&&(t.normalScale=new THREE.Vector2(s.amplitude,s.amplitude));break;case"Bump":t.bumpMap=i;break}}return t.roughnessMap&&t.specularMap&&delete t.specularMap,t}parseAttributeImageMaps(e,t,a){for(const s in e){const r=e[s];if(r.maps){const e=r.maps[0],i=this.getTexturePathByIndex(e.imageIndex,t);if(!i)return;const o=this.loadTexture(i);switch(void 0!==e.wrap&&(o.wrapS=this.getWrappingType(e.wrap.w)),void 0!==e.wrap&&(o.wrapT=this.getWrappingType(e.wrap.h)),s){case"Color":a.map=o;break;case"Diffuse":a.aoMap=o;break;case"Roughness":a.roughnessMap=o,a.roughness=1;break;case"Specular":a.specularMap=o,a.specular=16777215;break;case"Luminosity":a.emissiveMap=o,a.emissive=8421504;break;case"Metallic":a.metalnessMap=o,a.metalness=1;break;case"Transparency":case"Alpha":a.alphaMap=o,a.transparent=!0;break;case"Normal":a.normalMap=o;break;case"Bump":a.bumpMap=o;break}}}}parseAttributes(e,t){const a={};return e.Color&&!t.map?a.color=(new THREE.Color).fromArray(e.Color.value):a.color=new THREE.Color,e.Transparency&&0!==e.Transparency.value&&(a.opacity=1-e.Transparency.value,a.transparent=!0),e["Bump Height"]&&(a.bumpScale=.1*e["Bump Height"].value),e["Refraction Index"]&&(a.refractionRatio=.98/e["Refraction Index"].value),this.parsePhysicalAttributes(a,e,t),this.parseStandardAttributes(a,e,t),this.parsePhongAttributes(a,e,t),a}parsePhysicalAttributes(e,t){t.Clearcoat&&t.Clearcoat.value>0&&(e.clearcoat=t.Clearcoat.value,t["Clearcoat Gloss"]&&(e.clearcoatRoughness=.5*(1-t["Clearcoat Gloss"].value)))}parseStandardAttributes(e,t,a){t.Luminous&&(e.emissiveIntensity=t.Luminous.value,t["Luminous THREE.Color"]&&!a.emissive?e.emissive=(new THREE.Color).fromArray(t["Luminous THREE.Color"].value):e.emissive=new THREE.Color(8421504)),t.Roughness&&!a.roughnessMap&&(e.roughness=t.Roughness.value),t.Metallic&&!a.metalnessMap&&(e.metalness=t.Metallic.value)}parsePhongAttributes(e,t,a){t.Diffuse&&e.color.multiplyScalar(t.Diffuse.value),t.Reflection&&(e.reflectivity=t.Reflection.value,e.combine=THREE.AddOperation),t.Luminosity&&(e.emissiveIntensity=t.Luminosity.value,a.emissiveMap||a.map?e.emissive=new THREE.Color(8421504):e.emissive=e.color),t.Roughness||!t.Specular||a.specularMap||(t["Color Highlight"]?e.specular=(new THREE.Color).setScalar(t.Specular.value).lerp(e.color.clone().multiplyScalar(t.Specular.value),t["Color Highlight"].value):e.specular=(new THREE.Color).setScalar(t.Specular.value)),e.specular&&t.Glossiness&&(e.shininess=7+Math.pow(2,12*t.Glossiness.value+2))}parseEnvMap(e,t,a){if(e.envMap){const s=this.loadTexture(e.envMap);a.transparent&&a.opacity<.999?(s.mapping=THREE.EquirectangularRefractionMapping,void 0!==a.reflectivity&&(delete a.reflectivity,delete a.combine),void 0!==a.metalness&&(a.metalness=1),a.opacity=1):s.mapping=THREE.EquirectangularReflectionMapping,t.envMap=s}}getTexturePathByIndex(t){let a="";return e.textures?(e.textures.forEach((function(e){e.index===t&&(a=e.fileName)})),a):a}loadTexture(e){if(!e)return null;const t=this.textureLoader.load(e,void 0,void 0,(function(){console.warn("LWOLoader: non-standard resource hierarchy. Use `resourcePath` parameter to specify root content directory.")}));return t}getWrappingType(e){switch(e){case 0:return console.warn('LWOLoader: "Reset" texture wrapping type is not supported in three.js'),THREE.ClampToEdgeWrapping;case 1:return THREE.RepeatWrapping;case 2:return THREE.MirroredRepeatWrapping;case 3:return THREE.ClampToEdgeWrapping}}getMaterialType(e){return e.Clearcoat&&e.Clearcoat.value>0?THREE.MeshPhysicalMaterial:e.Roughness?THREE.MeshStandardMaterial:THREE.MeshPhongMaterial}}class r{parse(e,t){const a=new THREE.BufferGeometry;a.setAttribute("position",new THREE.Float32BufferAttribute(e.points,3));const s=this.splitIndices(e.vertexIndices,e.polygonDimensions);return a.setIndex(s),this.parseGroups(a,e),a.computeVertexNormals(),this.parseUVs(a,t,s),this.parseMorphTargets(a,t,s),a.translate(-t.pivot[0],-t.pivot[1],-t.pivot[2]),a}splitIndices(e,t){const a=[];let s=0;return t.forEach((function(t){if(t<4)for(let r=0;r<t;r++)a.push(e[s+r]);else if(4===t)a.push(e[s],e[s+1],e[s+2],e[s],e[s+2],e[s+3]);else if(t>4){for(let r=1;r<t-1;r++)a.push(e[s],e[s+r],e[s+r+1]);console.warn("LWOLoader: polygons with greater than 4 sides are not supported")}s+=t})),a}parseGroups(t,a){const s=e.tags,r=[];let i=3;"lines"===a.type&&(i=2),"points"===a.type&&(i=1);const o=this.splitMaterialIndices(a.polygonDimensions,a.materialIndices);let n=0;const p={};let u,l,c=0,h=0;for(let e=0;e<o.length;e+=2){if(l=o[e+1],0===e&&(r[n]=s[l]),void 0===u&&(u=l),l!==u){let e;p[s[u]]?e=p[s[u]]:(e=n,p[s[u]]=n,r[n]=s[u],n++),t.addGroup(c,h,e),c+=h,u=l,h=0}h+=i}if(t.groups.length>0){let e;p[s[l]]?e=p[s[l]]:(e=n,p[s[l]]=n,r[n]=s[l]),t.addGroup(c,h,e)}t.userData.matNames=r}splitMaterialIndices(e,t){const a=[];return e.forEach((function(e,s){if(e<=3)a.push(t[2*s],t[2*s+1]);else if(4===e)a.push(t[2*s],t[2*s+1],t[2*s],t[2*s+1]);else for(let r=0;r<e-2;r++)a.push(t[2*s],t[2*s+1])})),a}parseUVs(e,t){const a=Array.from(Array(2*e.attributes.position.count),(function(){return 0}));for(const s in t.uvs){const e=t.uvs[s].uvs,r=t.uvs[s].uvIndices;r.forEach((function(t,s){a[2*t]=e[2*s],a[2*t+1]=e[2*s+1]}))}e.setAttribute("uv",new THREE.Float32BufferAttribute(a,2))}parseMorphTargets(e,t){let a=0;for(const s in t.morphTargets){const r=e.attributes.position.array.slice();e.morphAttributes.position||(e.morphAttributes.position=[]);const i=t.morphTargets[s].points,o=t.morphTargets[s].indices,n=t.morphTargets[s].type;o.forEach((function(e,t){"relative"===n?(r[3*e]+=i[3*t],r[3*e+1]+=i[3*t+1],r[3*e+2]+=i[3*t+2]):(r[3*e]=i[3*t],r[3*e+1]=i[3*t+1],r[3*e+2]=i[3*t+2])})),e.morphAttributes.position[a]=new THREE.Float32BufferAttribute(r,3),e.morphAttributes.position[a].name=s,a++}e.morphTargetsRelative=!1}}function i(e,t){const a=e.indexOf(t);return-1===a?"./":e.substr(0,a)}THREE.LWOLoader=t})();