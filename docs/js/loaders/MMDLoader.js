(function(){class e extends THREE.Loader{constructor(e){super(e),this.loader=new THREE.FileLoader(this.manager),this.parser=null,this.meshBuilder=new a(this.manager),this.animationBuilder=new o}setAnimationPath(e){return this.animationPath=e,this}load(e,t,n,a){const i=this.meshBuilder.setCrossOrigin(this.crossOrigin);let r;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:THREE.LoaderUtils.extractUrlBase(e);const s=this._extractExtension(e).toLowerCase();"pmd"===s||"pmx"===s?this["pmd"===s?"loadPMD":"loadPMX"](e,(function(e){t(i.build(e,r,n,a))}),n,a):a&&a(new Error("THREE.MMDLoader: Unknown model file extension ."+s+"."))}loadAnimation(e,t,n,a,i){const r=this.animationBuilder;this.loadVMD(e,(function(e){n(t.isCamera?r.buildCameraAnimation(e):r.build(e,t))}),a,i)}loadWithAnimation(e,t,n,a,i){const r=this;this.load(e,(function(e){r.loadAnimation(t,e,(function(t){n({mesh:e,animation:t})}),a,i)}),a,i)}loadPMD(e,t,n,a){const i=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){t(i.parsePmd(e,!0))}),n,a)}loadPMX(e,t,n,a){const i=this._getParser();this.loader.setMimeType(void 0).setPath(this.path).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){t(i.parsePmx(e,!0))}),n,a)}loadVMD(e,t,n,a){const i=Array.isArray(e)?e:[e],r=[],s=i.length,o=this._getParser();this.loader.setMimeType(void 0).setPath(this.animationPath).setResponseType("arraybuffer").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials);for(let l=0,A=i.length;l<A;l++)this.loader.load(i[l],(function(e){r.push(o.parseVmd(e,!0)),r.length===s&&t(o.mergeVmds(r))}),n,a)}loadVPD(e,t,n,a,i){const r=this._getParser();this.loader.setMimeType(t?void 0:"text/plain; charset=shift_jis").setPath(this.animationPath).setResponseType("text").setRequestHeader(this.requestHeader).setWithCredentials(this.withCredentials).load(e,(function(e){n(r.parseVpd(e,!0))}),a,i)}_extractExtension(e){const t=e.lastIndexOf(".");return t<0?"":e.slice(t+1)}_getParser(){if(null===this.parser){if("undefined"===typeof MMDParser)throw new Error("THREE.MMDLoader: Import MMDParser https://github.com/takahirox/mmd-parser");this.parser=new MMDParser.Parser}return this.parser}}const t=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="],n=[THREE.RGB_S3TC_DXT1_Format,THREE.RGB_PVRTC_4BPPV1_Format,THREE.RGB_PVRTC_2BPPV1_Format,THREE.RGB_ETC1_Format,THREE.RGB_ETC2_Format];class a{constructor(e){this.crossOrigin="anonymous",this.geometryBuilder=new r,this.materialBuilder=new s(e)}setCrossOrigin(e){return this.crossOrigin=e,this}build(e,t,n,a){const r=this.geometryBuilder.build(e),s=this.materialBuilder.setCrossOrigin(this.crossOrigin).setResourcePath(t).build(e,r,n,a),o=new THREE.SkinnedMesh(r,s),l=new THREE.Skeleton(i(o));return o.bind(l),o}}function i(e){const t=e.geometry,n=[];if(t&&void 0!==t.bones){for(let e=0,a=t.bones.length;e<a;e++){const a=t.bones[e],i=new THREE.Bone;n.push(i),i.name=a.name,i.position.fromArray(a.pos),i.quaternion.fromArray(a.rotq),void 0!==a.scl&&i.scale.fromArray(a.scl)}for(let a=0,i=t.bones.length;a<i;a++){const i=t.bones[a];-1!==i.parent&&null!==i.parent&&void 0!==n[i.parent]?n[i.parent].add(n[a]):e.add(n[a])}}return e.updateMatrixWorld(!0),n}class r{build(e){const t=[],n=[],a=[],i=[],r=[],s=[],o=[],l=[],A=[],h=[],u=[],d=[],c=[],p=[];let m=0;const f={};for(let T=0;T<e.metadata.vertexCount;T++){const R=e.vertices[T];for(let C=0,x=R.position.length;C<x;C++)t.push(R.position[C]);for(let b=0,y=R.normal.length;b<y;b++)a.push(R.normal[b]);for(let B=0,M=R.uv.length;B<M;B++)n.push(R.uv[B]);for(let H=0;H<4;H++)o.push(R.skinIndices.length-1>=H?R.skinIndices[H]:0);for(let I=0;I<4;I++)l.push(R.skinWeights.length-1>=I?R.skinWeights[I]:0)}for(let w=0;w<e.metadata.faceCount;w++){const k=e.faces[w];for(let P=0,Q=k.indices.length;P<Q;P++)i.push(k.indices[P])}for(let v=0;v<e.metadata.materialCount;v++){const D=e.materials[v];r.push({offset:3*m,count:3*D.faceCount}),m+=D.faceCount}for(let S=0;S<e.metadata.rigidBodyCount;S++){const L=e.rigidBodies[S];let U=f[L.boneIndex];U=void 0===U?L.type:Math.max(L.type,U),f[L.boneIndex]=U}for(let N=0;N<e.metadata.boneCount;N++){const O=e.bones[N],V={index:N,transformationClass:O.transformationClass,parent:O.parentIndex,name:O.name,pos:O.position.slice(0,3),rotq:[0,0,0,1],scl:[1,1,1],rigidBodyType:void 0!==f[N]?f[N]:-1};-1!==V.parent&&(V.pos[0]-=e.bones[V.parent].position[0],V.pos[1]-=e.bones[V.parent].position[1],V.pos[2]-=e.bones[V.parent].position[2]),s.push(V)}if("pmd"===e.metadata.format)for(let F=0;F<e.metadata.ikCount;F++){const _=e.iks[F],Y={target:_.target,effector:_.effector,iteration:_.iteration,maxAngle:4*_.maxAngle,links:[]};for(let z=0,G=_.links.length;z<G;z++){const K={};K.index=_.links[z].index,K.enabled=!0,e.bones[K.index].name.indexOf("ひざ")>=0&&(K.limitation=new THREE.Vector3(1,0,0)),Y.links.push(K)}u.push(Y)}else for(let W=0;W<e.metadata.boneCount;W++){const J=e.bones[W].ik;if(void 0===J)continue;const j={target:W,effector:J.effector,iteration:J.iteration,maxAngle:J.maxAngle,links:[]};for(let X=0,q=J.links.length;X<q;X++){const Z={};if(Z.index=J.links[X].index,Z.enabled=!0,1===J.links[X].angleLimitation){const $=J.links[X].lowerLimitationAngle,ee=J.links[X].upperLimitationAngle,te=-ee[0],ne=-ee[1];ee[0]=-$[0],ee[1]=-$[1],$[0]=te,$[1]=ne,Z.rotationMin=(new THREE.Vector3).fromArray($),Z.rotationMax=(new THREE.Vector3).fromArray(ee)}j.links.push(Z)}u.push(j),s[W].ik=j}if("pmx"===e.metadata.format){const ae={};for(let se=0;se<e.metadata.boneCount;se++){const oe=e.bones[se],le=oe.grant;if(void 0===le)continue;const Ae={index:se,parentIndex:le.parentIndex,ratio:le.ratio,isLocal:le.isLocal,affectRotation:le.affectRotation,affectPosition:le.affectPosition,transformationClass:oe.transformationClass};ae[se]={parent:null,children:[],param:Ae,visited:!1}}const ie={parent:null,children:[],param:null,visited:!1};for(const he in ae){const ue=ae[he],de=ae[ue.parentIndex]||ie;ue.parent=de,de.children.push(ue)}function re(e){e.param&&(d.push(e.param),s[e.param.index].grant=e.param),e.visited=!0;for(let t=0,n=e.children.length;t<n;t++){const n=e.children[t];n.visited||re(n)}}re(ie)}function g(t,n,a){for(let i=0;i<n.elementCount;i++){const r=n.elements[i];let s;s="pmd"===e.metadata.format?e.morphs[0].elements[r.index].index:r.index,t.array[3*s+0]+=r.position[0]*a,t.array[3*s+1]+=r.position[1]*a,t.array[3*s+2]+=r.position[2]*a}}for(let ce=0;ce<e.metadata.morphCount;ce++){const pe=e.morphs[ce],me={name:pe.name},fe=new THREE.Float32BufferAttribute(3*e.metadata.vertexCount,3);fe.name=pe.name;for(let ge=0;ge<3*e.metadata.vertexCount;ge++)fe.array[ge]=t[ge];if("pmd"===e.metadata.format)0!==ce&&g(fe,pe,1);else if(0===pe.type)for(let Ee=0;Ee<pe.elementCount;Ee++){const Te=e.morphs[pe.elements[Ee].index],Re=pe.elements[Ee].ratio;1===Te.type&&g(fe,Te,Re)}else 1===pe.type?g(fe,pe,1):2===pe.type||3===pe.type||4===pe.type||5===pe.type||6===pe.type||7===pe.type||pe.type;A.push(me),h.push(fe)}for(let Ce=0;Ce<e.metadata.rigidBodyCount;Ce++){const xe=e.rigidBodies[Ce],be={};for(const ye in xe)be[ye]=xe[ye];if("pmx"===e.metadata.format&&-1!==be.boneIndex){const Be=e.bones[be.boneIndex];be.position[0]-=Be.position[0],be.position[1]-=Be.position[1],be.position[2]-=Be.position[2]}c.push(be)}for(let Me=0;Me<e.metadata.constraintCount;Me++){const He=e.constraints[Me],Ie={};for(const Pe in He)Ie[Pe]=He[Pe];const we=c[Ie.rigidBodyIndex1],ke=c[Ie.rigidBodyIndex2];0!==we.type&&2===ke.type&&-1!==we.boneIndex&&-1!==ke.boneIndex&&e.bones[ke.boneIndex].parentIndex===we.boneIndex&&(ke.type=1),p.push(Ie)}const E=new THREE.BufferGeometry;E.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),E.setAttribute("normal",new THREE.Float32BufferAttribute(a,3)),E.setAttribute("uv",new THREE.Float32BufferAttribute(n,2)),E.setAttribute("skinIndex",new THREE.Uint16BufferAttribute(o,4)),E.setAttribute("skinWeight",new THREE.Float32BufferAttribute(l,4)),E.setIndex(i);for(let Qe=0,ve=r.length;Qe<ve;Qe++)E.addGroup(r[Qe].offset,r[Qe].count,Qe);return E.bones=s,E.morphTargets=A,E.morphAttributes.position=h,E.morphTargetsRelative=!1,E.userData.MMD={bones:s,iks:u,grants:d,rigidBodies:c,constraints:p,format:e.metadata.format},E.computeBoundingSphere(),E}}class s{constructor(e){this.manager=e,this.textureLoader=new THREE.TextureLoader(this.manager),this.tgaLoader=null,this.crossOrigin="anonymous",this.resourcePath=void 0}setCrossOrigin(e){return this.crossOrigin=e,this}setResourcePath(e){return this.resourcePath=e,this}build(e,t){const n=[],a={};this.textureLoader.setCrossOrigin(this.crossOrigin);for(let i=0;i<e.metadata.materialCount;i++){const r=e.materials[i],s={userData:{MMD:{}}};if(void 0!==r.name&&(s.name=r.name),s.diffuse=(new THREE.Color).fromArray(r.diffuse),s.opacity=r.diffuse[3],s.specular=(new THREE.Color).fromArray(r.specular),s.shininess=r.shininess,s.emissive=(new THREE.Color).fromArray(r.ambient),s.transparent=1!==s.opacity,s.fog=!0,s.blending=THREE.CustomBlending,s.blendSrc=THREE.SrcAlphaFactor,s.blendDst=THREE.OneMinusSrcAlphaFactor,s.blendSrcAlpha=THREE.SrcAlphaFactor,s.blendDstAlpha=THREE.DstAlphaFactor,"pmx"===e.metadata.format&&1===(1&r.flag)?s.side=THREE.DoubleSide:s.side=1===s.opacity?THREE.FrontSide:THREE.DoubleSide,"pmd"===e.metadata.format){if(r.fileName){const l=r.fileName,h=l.split("*");if(s.map=this._loadTexture(h[0],a),h.length>1){const u=h[1].slice(-4).toLowerCase();s.envMap=this._loadTexture(h[1],a),s.combine=".sph"===u?THREE.MultiplyOperation:THREE.AddOperation}}const o=-1===r.toonIndex?"toon00.bmp":e.toonTextures[r.toonIndex].fileName;s.gradientMap=this._loadTexture(o,a,{isToonTexture:!0,isDefaultToonTexture:this._isDefaultToonTexture(o)}),s.userData.outlineParameters={thickness:1===r.edgeFlag?.003:0,color:[0,0,0],alpha:1,visible:1===r.edgeFlag}}else{let d,c;-1!==r.textureIndex&&(s.map=this._loadTexture(e.textures[r.textureIndex],a),s.userData.MMD.mapFileName=e.textures[r.textureIndex]),-1===r.envTextureIndex||1!==r.envFlag&&2!=r.envFlag||(s.matcap=this._loadTexture(e.textures[r.envTextureIndex],a),s.userData.MMD.matcapFileName=e.textures[r.envTextureIndex],s.matcapCombine=1===r.envFlag?THREE.MultiplyOperation:THREE.AddOperation),-1===r.toonIndex||0!==r.toonFlag?(d="toon"+("0"+(r.toonIndex+1)).slice(-2)+".bmp",c=!0):(d=e.textures[r.toonIndex],c=!1),s.gradientMap=this._loadTexture(d,a,{isToonTexture:!0,isDefaultToonTexture:c}),s.userData.outlineParameters={thickness:r.edgeSize/300,color:r.edgeColor.slice(0,3),alpha:r.edgeColor[3],visible:0!==(16&r.flag)&&r.edgeSize>0}}void 0!==s.map&&(s.transparent||this._checkImageTransparency(s.map,t,i),s.emissive.multiplyScalar(.2)),n.push(new A(s))}if("pmx"===e.metadata.format){function p(e,t){for(let n=0,a=e.length;n<a;n++){const a=e[n];if(-1===a.index)continue;const i=t[a.index];i.opacity!==a.diffuse[3]&&(i.transparent=!0)}}for(let m=0,f=e.morphs.length;m<f;m++){const g=e.morphs[m],E=g.elements;if(0===g.type)for(let T=0,R=E.length;T<R;T++){const C=e.morphs[E[T].index];8===C.type&&p(C.elements,n)}else 8===g.type&&p(E,n)}}return n}_getTGALoader(){if(null===this.tgaLoader){if(void 0===THREE.TGALoader)throw new Error("THREE.MMDLoader: Import THREE.TGALoader");this.tgaLoader=new THREE.TGALoader(this.manager)}return this.tgaLoader}_isDefaultToonTexture(e){return 10===e.length&&/toon(10|0[0-9])\.bmp/.test(e)}_loadTexture(e,n,a,i,r){a=a||{};const s=this;let o;if(!0===a.isDefaultToonTexture){let n;try{n=parseInt(e.match(/toon([0-9]{2})\.bmp$/)[1])}catch(h){console.warn("THREE.MMDLoader: "+e+" seems like a not right default texture path. Using toon00.bmp instead."),n=0}o=t[n]}else o=this.resourcePath+e;if(void 0!==n[o])return n[o];let l=this.manager.getHandler(o);null===l&&(l=".tga"===e.slice(-4).toLowerCase()?this._getTGALoader():this.textureLoader);const A=l.load(o,(function(e){!0===a.isToonTexture&&(e.image=s._getRotatedImage(e.image),e.magFilter=THREE.NearestFilter,e.minFilter=THREE.NearestFilter),e.flipY=!1,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping;for(let t=0;t<A.readyCallbacks.length;t++)A.readyCallbacks[t](A);delete A.readyCallbacks}),i,r);return A.readyCallbacks=[],n[o]=A,A}_getRotatedImage(e){const t=document.createElement("canvas"),n=t.getContext("2d"),a=e.width,i=e.height;return t.width=a,t.height=i,n.clearRect(0,0,a,i),n.translate(a/2,i/2),n.rotate(.5*Math.PI),n.translate(-a/2,-i/2),n.drawImage(e,0,0),n.getImageData(0,0,a,i)}_checkImageTransparency(e,t,a){e.readyCallbacks.push((function(i){function r(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,t.width,t.height)}function s(e,t,n){const a=e.width,i=e.height,r=e.data,s=253;if(r.length/(a*i)!==4)return!1;for(let l=0;l<n.length;l+=3){const a={x:0,y:0};for(let i=0;i<3;i++){const r=n[3*l+i],A={x:t[2*r+0],y:t[2*r+1]};if(o(e,A)<s)return!0;a.x+=A.x,a.y+=A.y}if(a.x/=3,a.y/=3,o(e,a)<s)return!0}return!1}function o(e,t){const n=e.width,a=e.height;let i=Math.round(t.x*n)%n,r=Math.round(t.y*a)%a;i<0&&(i+=n),r<0&&(r+=a);const s=r*n+i;return e.data[4*s+3]}if(!0===i.isCompressedTexture)return void(n.includes(i.format)?e.transparent=!1:e.transparent=!0);const l=void 0!==i.image.data?i.image:r(i.image),A=t.groups[a];s(l,t.attributes.uv.array,t.index.array.slice(A.start,A.start+A.count))&&(e.transparent=!0)}))}}class o{build(e,t){const n=this.buildSkeletalAnimation(e,t).tracks,a=this.buildMorphAnimation(e,t).tracks;for(let i=0,r=a.length;i<r;i++)n.push(a[i]);return new THREE.AnimationClip("",-1,n)}buildSkeletalAnimation(e,t){function n(e,t,n){e.push(t[n+0]/127),e.push(t[n+8]/127),e.push(t[n+4]/127),e.push(t[n+12]/127)}const a=[],i={},r=t.skeleton.bones,s={};for(let o=0,l=r.length;o<l;o++)s[r[o].name]=!0;for(let o=0;o<e.metadata.motionCount;o++){const t=e.motions[o],n=t.boneName;void 0!==s[n]&&(i[n]=i[n]||[],i[n].push(t))}for(const o in i){const e=i[o];e.sort((function(e,t){return e.frameNum-t.frameNum}));const r=[],s=[],l=[],A=[],h=[],u=t.skeleton.getBoneByName(o).position.toArray();for(let t=0,a=e.length;t<a;t++){const a=e[t].frameNum/30,i=e[t].position,o=e[t].rotation,d=e[t].interpolation;r.push(a);for(let e=0;e<3;e++)s.push(u[e]+i[e]);for(let e=0;e<4;e++)l.push(o[e]);for(let e=0;e<3;e++)n(A,d,e);n(h,d,3)}const d=".bones["+o+"]";a.push(this._createTrack(d+".position",THREE.VectorKeyframeTrack,r,s,A)),a.push(this._createTrack(d+".quaternion",THREE.QuaternionKeyframeTrack,r,l,h))}return new THREE.AnimationClip("",-1,a)}buildMorphAnimation(e,t){const n=[],a={},i=t.morphTargetDictionary;for(let r=0;r<e.metadata.morphCount;r++){const t=e.morphs[r],n=t.morphName;void 0!==i[n]&&(a[n]=a[n]||[],a[n].push(t))}for(const r in a){const e=a[r];e.sort((function(e,t){return e.frameNum-t.frameNum}));const t=[],s=[];for(let n=0,a=e.length;n<a;n++)t.push(e[n].frameNum/30),s.push(e[n].weight);n.push(new THREE.NumberKeyframeTrack(".morphTargetInfluences["+i[r]+"]",t,s))}return new THREE.AnimationClip("",-1,n)}buildCameraAnimation(e){function t(e,t){e.push(t.x),e.push(t.y),e.push(t.z)}function n(e,t){e.push(t.x),e.push(t.y),e.push(t.z),e.push(t.w)}function a(e,t,n){e.push(t[4*n+0]/127),e.push(t[4*n+1]/127),e.push(t[4*n+2]/127),e.push(t[4*n+3]/127)}const i=void 0===e.cameras?[]:e.cameras.slice();i.sort((function(e,t){return e.frameNum-t.frameNum}));const r=[],s=[],o=[],l=[],A=[],h=[],u=[],d=[],c=[],p=new THREE.Quaternion,m=new THREE.Euler,f=new THREE.Vector3,g=new THREE.Vector3;for(let T=0,R=i.length;T<R;T++){const e=i[T],E=e.frameNum/30,R=e.position,C=e.rotation,x=e.distance,b=e.fov,y=e.interpolation;r.push(E),f.set(0,0,-x),g.set(R[0],R[1],R[2]),m.set(-C[0],-C[1],-C[2]),p.setFromEuler(m),f.add(g),f.applyQuaternion(p),t(s,g),n(o,p),t(l,f),A.push(b);for(let t=0;t<3;t++)a(h,y,t);a(u,y,3);for(let t=0;t<3;t++)a(d,y,4);a(c,y,5)}const E=[];return E.push(this._createTrack("target.position",THREE.VectorKeyframeTrack,r,s,h)),E.push(this._createTrack(".quaternion",THREE.QuaternionKeyframeTrack,r,o,u)),E.push(this._createTrack(".position",THREE.VectorKeyframeTrack,r,l,d)),E.push(this._createTrack(".fov",THREE.NumberKeyframeTrack,r,A,c)),new THREE.AnimationClip("",-1,E)}_createTrack(e,t,n,a,i){if(n.length>2){n=n.slice(),a=a.slice(),i=i.slice();const e=a.length/n.length,t=i.length/n.length;let r=1;for(let s=2,o=n.length;s<o;s++){for(let t=0;t<e;t++)if(a[r*e+t]!==a[(r-1)*e+t]||a[r*e+t]!==a[s*e+t]){r++;break}if(s>r){n[r]=n[s];for(let t=0;t<e;t++)a[r*e+t]=a[s*e+t];for(let e=0;e<t;e++)i[r*t+e]=i[s*t+e]}}n.length=r+1,a.length=(r+1)*e,i.length=(r+1)*t}const r=new t(e,n,a);return r.createInterpolant=function(e){return new l(this.times,this.values,this.getValueSize(),e,new Float32Array(i))},r}}class l extends THREE.Interpolant{constructor(e,t,n,a,i){super(e,t,n,a),this.interpolationParams=i}interpolate_(e,t,n,a){const i=this.resultBuffer,r=this.sampleValues,s=this.valueSize,o=this.interpolationParams,l=e*s,A=l-s,h=a-t<.05?0:(n-t)/(a-t);if(4===s){const t=o[4*e+0],n=o[4*e+1],a=o[4*e+2],s=o[4*e+3],u=this._calculate(t,n,a,s,h);THREE.Quaternion.slerpFlat(i,0,r,A,r,l,u)}else if(3===s)for(let u=0;u!==s;++u){const t=o[12*e+4*u+0],n=o[12*e+4*u+1],a=o[12*e+4*u+2],s=o[12*e+4*u+3],d=this._calculate(t,n,a,s,h);i[u]=r[A+u]*(1-d)+r[l+u]*d}else{const t=o[4*e+0],n=o[4*e+1],a=o[4*e+2],s=o[4*e+3],u=this._calculate(t,n,a,s,h);i[0]=r[A]*(1-u)+r[l]*u}return i}_calculate(e,t,n,a,i){let r=.5,s=r,o=1-s;const l=15,A=1e-5,h=Math;let u,d,c;for(let p=0;p<l;p++){u=3*o*o*s,d=3*o*s*s,c=s*s*s;const n=u*e+d*t+c-i;if(h.abs(n)<A)break;r/=2,s+=n<0?r:-r,o=1-s}return u*n+d*a+c}}class A extends THREE.ShaderMaterial{constructor(e){super(),this._matcapCombine=THREE.AddOperation,this.emissiveIntensity=1,this.normalMapType=THREE.TangentSpaceNormalMap,this.combine=THREE.MultiplyOperation,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.lights=!0,this.vertexShader=THREE.MMDToonShader.vertexShader,this.fragmentShader=THREE.MMDToonShader.fragmentShader,this.defines=Object.assign({},THREE.MMDToonShader.defines),Object.defineProperty(this,"matcapCombine",{get:function(){return this._matcapCombine},set:function(e){switch(this._matcapCombine=e,e){case THREE.MultiplyOperation:this.defines.MATCAP_BLENDING_MULTIPLY=!0,delete this.defines.MATCAP_BLENDING_ADD;break;default:case THREE.AddOperation:this.defines.MATCAP_BLENDING_ADD=!0,delete this.defines.MATCAP_BLENDING_MULTIPLY;break}}}),this.uniforms=THREE.UniformsUtils.clone(THREE.MMDToonShader.uniforms);const t=["specular","shininess","opacity","diffuse","map","matcap","gradientMap","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveMap","bumpMap","bumpScale","normalMap","normalScale","displacemantBias","displacemantMap","displacemantScale","specularMap","alphaMap","envMap","reflectivity","refractionRatio"];for(const n of t)Object.defineProperty(this,n,{get:function(){return this.uniforms[n].value},set:function(e){this.uniforms[n].value=e}});Object.defineProperty(this,"color",Object.getOwnPropertyDescriptor(this,"diffuse")),this.setValues(e)}copy(e){return super.copy(e),this.matcapCombine=e.matcapCombine,this.emissiveIntensity=e.emissiveIntensity,this.normalMapType=e.normalMapType,this.combine=e.combine,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}A.prototype.isMMDToonMaterial=!0,THREE.MMDLoader=e})();