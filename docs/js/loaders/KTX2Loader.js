(function(){const e=2,r=1,t=new WeakMap;let o=0;class s extends THREE.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new THREE.WorkerPool,this.workerSourceURL="",this.workerConfig=null,"undefined"!==typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},e.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}init(){if(!this.transcoderPending){const e=new THREE.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const r=e.loadAsync("basis_transcoder.js"),t=new THREE.FileLoader(this.manager);t.setPath(this.transcoderPath),t.setResponseType("arraybuffer"),t.setWithCredentials(this.withCredentials);const n=t.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([r,n]).then((([e,r])=>{const t=s.BasisWorker.toString(),o=["/* constants */","let _EngineFormat = "+JSON.stringify(s.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(s.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(s.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",t.substring(t.indexOf("{")+1,t.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([o])),this.transcoderBinary=r,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),r=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:r},[r]),e}))})),o>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),o++}return this.transcoderPending}load(e,r,o,s){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const n=new THREE.FileLoader(this.manager);n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);const a=new THREE.CompressedTexture;return n.load(e,(e=>{if(t.has(e)){const o=t.get(e);return o.promise.then(r).catch(s)}this._createTexture([e]).then((function(e){a.copy(e),a.needsUpdate=!0,r&&r(a)})).catch(s)}),o,s),a}_createTextureFrom(t){const{mipmaps:o,width:s,height:n,format:a,type:i,error:d,dfdTransferFn:T,dfdFlags:c}=t;if("error"===i)return Promise.reject(d);const _=new THREE.CompressedTexture(o,s,n,a,THREE.UnsignedByteType);return _.minFilter=1===o.length?THREE.LinearFilter:THREE.LinearMipmapLinearFilter,_.magFilter=THREE.LinearFilter,_.generateMipmaps=!1,_.needsUpdate=!0,_.encoding=T===e?THREE.sRGBEncoding:THREE.LinearEncoding,_.premultiplyAlpha=!!(c&r),_}_createTexture(e,r={}){const o=r,s=this.init().then((()=>this.workerPool.postMessage({type:"transcode",buffers:e,taskConfig:o},e))).then((e=>this._createTextureFrom(e.data)));return t.set(e[0],{promise:s}),s}dispose(){return URL.revokeObjectURL(this.workerSourceURL),this.workerPool.dispose(),o--,this}}s.BasisFormat={ETC1S:0,UASTC_4x4:1},s.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},s.EngineFormat={RGBAFormat:THREE.RGBAFormat,RGBA_ASTC_4x4_Format:THREE.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:THREE.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:THREE.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:THREE.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:THREE.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:THREE.RGB_ETC1_Format,RGB_ETC2_Format:THREE.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:THREE.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:THREE.RGB_S3TC_DXT1_Format},s.BasisWorker=function(){let e,r,t;const o=_EngineFormat,s=_TranscoderFormat,n=_BasisFormat;function a(e){r=new Promise((r=>{t={wasmBinary:e,onRuntimeInitialized:r},BASIS(t)})).then((()=>{t.initializeBasis(),void 0===t.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")}))}function i(e){const r=new t.KTX2File(new Uint8Array(e));function o(){r.close(),r.delete()}if(!r.isValid())throw o(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");const s=r.isUASTC()?n.UASTC_4x4:n.ETC1S,a=r.getWidth(),i=r.getHeight(),d=r.getLevels(),T=r.getHasAlpha(),c=r.getDFDTransferFunc(),m=r.getDFDFlags(),{transcoderFormat:E,engineFormat:p}=_(s,a,i,T);if(!a||!i||!d)throw o(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!r.startTranscoding())throw o(),new Error("THREE.KTX2Loader: .startTranscoding failed");const h=[];for(let t=0;t<d;t++){const e=r.getImageLevelInfo(t,0,0),s=e.origWidth,n=e.origHeight,a=new Uint8Array(r.getImageTranscodedSizeInBytes(t,0,0,E)),i=r.transcodeImage(a,t,0,0,E,0,-1,-1);if(!i)throw o(),new Error("THREE.KTX2Loader: .transcodeImage failed.");h.push({data:a,width:s,height:n})}return o(),{width:a,height:i,hasAlpha:T,mipmaps:h,format:p,dfdTransferFn:c,dfdFlags:m}}self.addEventListener("message",(function(t){const o=t.data;switch(o.type){case"init":e=o.config,a(o.transcoderBinary);break;case"transcode":r.then((()=>{try{const{width:e,height:r,hasAlpha:t,mipmaps:s,format:n,dfdTransferFn:a,dfdFlags:d}=i(o.buffers[0]),T=[];for(let o=0;o<s.length;++o)T.push(s[o].data.buffer);self.postMessage({type:"transcode",id:o.id,width:e,height:r,hasAlpha:t,mipmaps:s,format:n,dfdTransferFn:a,dfdFlags:d},T)}catch(e){console.error(e),self.postMessage({type:"error",id:o.id,error:e.message})}}));break}}));const d=[{if:"astcSupported",basisFormat:[n.UASTC_4x4],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[o.RGBA_ASTC_4x4_Format,o.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[o.RGBA_BPTC_Format,o.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.BC1,s.BC3],engineFormat:[o.RGB_S3TC_DXT1_Format,o.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[o.RGB_ETC2_Format,o.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.ETC1],engineFormat:[o.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[o.RGB_PVRTC_4BPPV1_Format,o.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],T=d.sort((function(e,r){return e.priorityETC1S-r.priorityETC1S})),c=d.sort((function(e,r){return e.priorityUASTC-r.priorityUASTC}));function _(r,t,a,i){let d,_;const E=r===n.ETC1S?T:c;for(let o=0;o<E.length;o++){const s=E[o];if(e[s.if]&&(s.basisFormat.includes(r)&&!(i&&s.transcoderFormat.length<2)&&(!s.needsPowerOfTwo||m(t)&&m(a))))return d=s.transcoderFormat[i?1:0],_=s.engineFormat[i?1:0],{transcoderFormat:d,engineFormat:_}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),d=s.RGBA32,_=o.RGBAFormat,{transcoderFormat:d,engineFormat:_}}function m(e){return e<=2||0===(e&e-1)&&0!==e}},THREE.KTX2Loader=s})();