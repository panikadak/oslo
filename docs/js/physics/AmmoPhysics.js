(function(){async function t(){if("Ammo"in window===!1)return void console.error("AmmoPhysics: Couldn't find Ammo.js");const t=await Ammo(),n=60,o=new t.btDefaultCollisionConfiguration,i=new t.btCollisionDispatcher(o),s=new t.btDbvtBroadphase,r=new t.btSequentialImpulseConstraintSolver,a=new t.btDiscreteDynamicsWorld(i,s,r,o);a.setGravity(new t.btVector3(0,-9.8,0));const c=new t.btTransform;function d(e){const n=e.parameters;if("BoxGeometry"===e.type){const e=void 0!==n.width?n.width/2:.5,o=void 0!==n.height?n.height/2:.5,i=void 0!==n.depth?n.depth/2:.5,s=new t.btBoxShape(new t.btVector3(e,o,i));return s.setMargin(.05),s}if("SphereGeometry"===e.type||"IcosahedronGeometry"===e.type){const e=void 0!==n.radius?n.radius:1,o=new t.btSphereShape(e);return o.setMargin(.05),o}return null}const l=[],u=new WeakMap;function w(t,e=0){const n=d(t.geometry);null!==n&&(t.isInstancedMesh?y(t,e,n):t.isMesh&&f(t,e,n))}function f(e,n,o){const i=e.position,s=e.quaternion,r=new t.btTransform;r.setIdentity(),r.setOrigin(new t.btVector3(i.x,i.y,i.z)),r.setRotation(new t.btQuaternion(s.x,s.y,s.z,s.w));const c=new t.btDefaultMotionState(r),d=new t.btVector3(0,0,0);o.calculateLocalInertia(n,d);const w=new t.btRigidBodyConstructionInfo(n,c,o,d),f=new t.btRigidBody(w);a.addRigidBody(f),n>0&&(l.push(e),u.set(e,f))}function y(e,n,o){const i=e.instanceMatrix.array,s=[];for(let r=0;r<e.count;r++){const e=16*r,c=new t.btTransform;c.setFromOpenGLMatrix(i.slice(e,e+16));const d=new t.btDefaultMotionState(c),l=new t.btVector3(0,0,0);o.calculateLocalInertia(n,l);const u=new t.btRigidBodyConstructionInfo(n,d,o,l),w=new t.btRigidBody(u);a.addRigidBody(w),s.push(w)}n>0&&(l.push(e),u.set(e,s))}function g(e,n,o=0){if(e.isInstancedMesh){const i=u.get(e),s=i[o];s.setAngularVelocity(new t.btVector3(0,0,0)),s.setLinearVelocity(new t.btVector3(0,0,0)),c.setIdentity(),c.setOrigin(new t.btVector3(n.x,n.y,n.z)),s.setWorldTransform(c)}else if(e.isMesh){const o=u.get(e);o.setAngularVelocity(new t.btVector3(0,0,0)),o.setLinearVelocity(new t.btVector3(0,0,0)),c.setIdentity(),c.setOrigin(new t.btVector3(n.x,n.y,n.z)),o.setWorldTransform(c)}}let h=0;function b(){const t=performance.now();if(h>0){const e=(t-h)/1e3;a.stepSimulation(e,10)}h=t;for(let n=0,o=l.length;n<o;n++){const t=l[n];if(t.isInstancedMesh){const n=t.instanceMatrix.array,o=u.get(t);for(let t=0;t<o.length;t++){const i=o[t],s=i.getMotionState();s.getWorldTransform(c);const r=c.getOrigin(),a=c.getRotation();e(r,a,n,16*t)}t.instanceMatrix.needsUpdate=!0}else if(t.isMesh){const e=u.get(t),n=e.getMotionState();n.getWorldTransform(c);const o=c.getOrigin(),i=c.getRotation();t.position.set(o.x(),o.y(),o.z()),t.quaternion.set(i.x(),i.y(),i.z(),i.w())}}}return setInterval(b,1e3/n),{addMesh:w,setMeshPosition:g}}function e(t,e,n,o){const i=e.x(),s=e.y(),r=e.z(),a=e.w(),c=i+i,d=s+s,l=r+r,u=i*c,w=i*d,f=i*l,y=s*d,g=s*l,h=r*l,b=a*c,m=a*d,p=a*l;n[o+0]=1-(y+h),n[o+1]=w+p,n[o+2]=f-m,n[o+3]=0,n[o+4]=w-p,n[o+5]=1-(u+h),n[o+6]=g+b,n[o+7]=0,n[o+8]=f+m,n[o+9]=g-b,n[o+10]=1-(u+y),n[o+11]=0,n[o+12]=t.x(),n[o+13]=t.y(),n[o+14]=t.z(),n[o+15]=1}THREE.AmmoPhysics=t})();